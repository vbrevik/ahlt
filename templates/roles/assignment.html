{% extends "base.html" %}

{% block title %}Role Assignment — {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block sidebar %}
{% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

<div class="page-header">
    <h1>Role Assignment</h1>
    {% if ctx.permissions.has("roles.manage") %}
    <a href="/roles/builder" class="btn btn-primary">New Role</a>
    {% endif %}
</div>

<div class="assignment-tabs">
    <a href="?tab=by-role" class="assignment-tabs__tab{% if active_tab.as_str() == "by-role" %} assignment-tabs__tab--active{% endif %}">By Role</a>
    <a href="?tab=by-user" class="assignment-tabs__tab{% if active_tab.as_str() == "by-user" %} assignment-tabs__tab--active{% endif %}">By User</a>
</div>

{% if active_tab.as_str() == "by-role" %}
<!-- BY ROLE TAB -->
<div class="role-selector">
    {% for role in roles %}
    <a href="?role_id={{ role.id }}&tab=by-role"
       class="role-selector__pill{% if role.id == selected_role_id %} role-selector__pill--active{% endif %}">
        {{ role.label }}
        <span class="badge badge-user">{{ role.user_count }}</span>
    </a>
    {% endfor %}
</div>

{% if selected_role_id > 0 %}
<div class="role-members">
    <h2 class="role-members__title">Members</h2>

    {% if members.is_empty() %}
    <p class="role-members__empty">No users assigned to this role.</p>
    {% else %}
    <table class="table">
        <thead>
            <tr>
                <th>Display Name</th>
                <th>Username</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for member in members %}
            <tr>
                <td>{{ member.display_name }}</td>
                <td><code class="mono-type">{{ member.username }}</code></td>
                <td class="actions">
                    <form method="post" action="/roles/unassign" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                        <input type="hidden" name="user_id" value="{{ member.user_id }}">
                        <input type="hidden" name="role_id" value="{{ selected_role_id }}">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    {% if !available_users.is_empty() %}
    <div class="role-members__add">
        <form method="post" action="/roles/assign" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
            <input type="hidden" name="role_id" value="{{ selected_role_id }}">
            <select name="user_id" class="form-control form-control--inline" required>
                <option value="">Add user...</option>
                {% for user in available_users %}
                <option value="{{ user.user_id }}">{{ user.display_name }} ({{ user.username }})</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Add</button>
        </form>
    </div>
    {% endif %}

    {% for role in roles %}
    {% if role.id == selected_role_id %}
    <div class="role-members__footer">
        {{ role.permission_count }} permissions ·
        <a href="/roles/builder/{{ role.id }}/edit">Edit in Role Builder</a>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

{% else %}
<!-- BY USER TAB -->
<table class="table">
    <thead>
        <tr>
            <th>User</th>
            <th>Assigned Roles</th>
            <th>Add Role</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    {% for user in users_with_roles %}
        <tr>
            <td>
                <strong>{{ user.display_name }}</strong>
                <br><code class="mono-type">{{ user.username }}</code>
            </td>
            <td>
                {% for role_tuple in user.roles %}
                <span class="badge badge-role">
                    {{ role_tuple.2 }}
                    <form method="post" action="/roles/unassign" class="inline badge-remove">
                        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <input type="hidden" name="role_id" value="{{ role_tuple.0 }}">
                        <button type="submit" class="badge-remove__btn" title="Remove role">&times;</button>
                    </form>
                </span>
                {% endfor %}
                {% if user.roles.is_empty() %}
                <span class="text-muted">No roles</span>
                {% endif %}
            </td>
            <td>
                <form method="post" action="/roles/assign" class="inline-form">
                    <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <select name="role_id" class="form-control form-control--inline form-control--sm">
                        <option value="">+ Add role</option>
                        {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.label }}</option>
                        {% endfor %}
                    </select>
                </form>
            </td>
            <td>
                <button type="button" class="btn btn-sm menu-preview-btn" data-user-id="{{ user.id }}">Preview</button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Menu Preview Panel -->
<div id="menu-preview" class="menu-preview" hidden>
    <div class="menu-preview__header">
        <h3 class="menu-preview__title">Effective Menu</h3>
        <button type="button" class="menu-preview__close" id="menu-preview-close">&times;</button>
    </div>
    <div id="menu-preview-content" class="menu-preview__content"></div>
</div>

{% include "roles/partials/assignment_js.html" %}

{% endblock %}
