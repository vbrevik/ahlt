{% extends "base.html" %}

{% block title %}{{ form_title }} â€” {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block sidebar %}
{% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
<h1>{{ form_title }}</h1>

{% for err in errors %}
<div class="alert alert-error">{{ err }}</div>
{% endfor %}

<form method="post" action="{{ form_action }}" class="form-card role-form">
    <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">

    <div class="role-basic-info">
        <div class="form-group">
            <label for="name">Name</label>
            <input type="text" id="name" name="name"
                   value="{% if let Some(r) = role %}{{ r.name }}{% endif %}" required>
            <span class="hint">Internal identifier (e.g. editor, viewer)</span>
        </div>
        <div class="form-group">
            <label for="label">Label</label>
            <input type="text" id="label" name="label"
                   value="{% if let Some(r) = role %}{{ r.label }}{% endif %}" required>
            <span class="hint">Display name shown to users</span>
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" name="description"
                   value="{% if let Some(r) = role %}{{ r.description }}{% endif %}">
        </div>
    </div>

    <fieldset class="permissions-section">
        <div class="permissions-header">
            <legend>Permissions</legend>
            <div class="permission-counter">
                <span class="counter-value" id="perm-counter">0</span>
                <span class="counter-label">selected</span>
            </div>
        </div>
        <p class="permissions-hint">Click cards to toggle permissions for this role. Multiple permissions can be selected.</p>

        <div class="permission-cards">
            {% for perm in permissions %}
            <label class="permission-card" data-group="{{ perm.group_name }}">
                <input type="checkbox" name="permissions" value="{{ perm.id }}"
                       {% if perm.checked %}checked{% endif %} class="permission-input">
                <div class="permission-card-inner">
                    <div class="permission-check">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="permission-content">
                        <div class="permission-label">{{ perm.label }}</div>
                        <code class="permission-code">{{ perm.code }}</code>
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>
    </fieldset>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Role</button>
        <a href="/roles" class="btn">Cancel</a>
    </div>
</form>

<script>
(function() {
    const counter = document.getElementById('perm-counter');
    const checkboxes = document.querySelectorAll('.permission-input');

    function updateCounter() {
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        counter.textContent = checked;
        counter.parentElement.classList.toggle('has-selections', checked > 0);
    }

    // Update counter on page load
    updateCounter();

    // Update counter on change
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCounter);
    });
})();
</script>
{% endblock %}
