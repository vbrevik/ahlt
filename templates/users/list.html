{% extends "base.html" %}

{% block title %}Users â€” {{ ctx.app_name }}{% endblock %}
{% block nav %}{% include "partials/nav.html" %}{% endblock %}
{% block sidebar %}{% include "partials/sidebar.html" %}{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

<div class="page-header">
    <h1>Users</h1>
    {% if ctx.permissions.has("users.create") %}
    <a href="/users/new" class="btn btn-primary">New User</a>
    {% endif %}
</div>

<script type="application/json" id="filter-state-json">{{ filter_json }}</script>
<script type="application/json" id="filter-fields-json">{{ fields_json }}</script>

{% include "partials/table_filter.html" %}
{% include "partials/table_controls.html" %}
{% include "partials/column_picker.html" %}

<div id="users-bulk-toolbar" class="users-bulk-toolbar" hidden>
    <span class="toolbar-label">
        <span id="users-selected-count">0</span> user<span id="users-plural">s</span> selected
    </span>
    <div class="toolbar-actions">
        {% if ctx.permissions.has("users.delete") %}
        <button type="button" class="btn btn-danger btn-sm" onclick="confirmBulkDelete()">
            Delete Selected
        </button>
        {% endif %}
        <button type="button" class="btn btn-sm" onclick="clearSelection()">Cancel</button>
    </div>
</div>

{% if user_page.users.is_empty() %}
<div class="empty-state">
    <div class="empty-state-icon">&#x1F465;</div>
    <div class="empty-state-title">No users found</div>
    <div class="empty-state-text">
        {% if filter_active %}
        No users match the active filters. <a href="/users">Clear filters</a>.
        {% else %}
        Create your first user to get started.
        {% endif %}
    </div>
</div>
{% else %}
<div class="table-wrapper">
    <table class="table users-table">
        <thead>
            <tr>
                <th class="users-table__checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" id="users-select-all" class="checkbox-input" onchange="toggleSelectAll()">
                        <span class="checkbox-mark"></span>
                    </label>
                </th>
                {% for col in columns %}
                {% if col.visible %}
                <th class="users-table__{{ col.key }}">
                    {% if col.sortable %}
                    <a href="/users?sort={{ col.sort_key }}&dir={% if sort_column.as_str() == col.sort_key.as_str() %}{% if sort_dir.as_str() == "asc" %}desc{% else %}asc{% endif %}{% else %}asc{% endif %}&filter={{ filter_json }}&per_page={{ user_page.per_page }}" class="sort-link">
                        {{ col.label }}{% if sort_column.as_str() == col.sort_key.as_str() %} {% if sort_dir.as_str() == "asc" %}&#x25B2;{% else %}&#x25BC;{% endif %}{% endif %}
                    </a>
                    {% else %}
                    {{ col.label }}
                    {% endif %}
                </th>
                {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
        {% for user in user_page.users %}
            <tr class="users-table__row" data-user-id="{{ user.id }}">
                <td class="users-table__checkbox">
                    <label class="checkbox-label">
                        <input type="checkbox" class="checkbox-input users-row-checkbox" value="{{ user.id }}" onchange="updateBulkToolbar()">
                        <span class="checkbox-mark"></span>
                    </label>
                </td>
                {% for col in columns %}
                {% if col.visible %}
                <td class="users-table__{{ col.key }}">
                    {% if col.key.as_str() == "user" %}
                    <div class="user-cell">
                        <div class="user-name">&#x1F464; {{ user.display_name }}</div>
                        <div class="user-username">@{{ user.username }}</div>
                        <div class="user-role"><span class="badge badge-{{ user.role_name }}">{{ user.role_label }}</span></div>
                    </div>
                    {% else %}
                    {% if col.key.as_str() == "email" %}
                    {{ user.email }}
                    {% else %}
                    {% if col.key.as_str() == "status" %}
                    <span class="status-badge status-active" title="Active">&#x2713; Active</span>
                    {% else %}
                    {% if col.key.as_str() == "created_at" %}
                    {{ user.created_at }}
                    {% else %}
                    {% if col.key.as_str() == "updated_at" %}
                    {{ user.updated_at }}
                    {% else %}
                    {% if col.key.as_str() == "actions" %}
                    <div class="action-buttons">
                        {% if ctx.permissions.has("users.edit") %}<a href="/users/{{ user.id }}/edit" class="btn btn-sm">Edit</a>{% endif %}
                        {% if ctx.permissions.has("users.delete") %}<button type="button" class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})">Delete</button>{% endif %}
                    </div>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% endif %}
                </td>
                {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if user_page.total_pages > 1 %}
<div class="pagination">
    <div class="pagination-info">Page {{ user_page.page }} of {{ user_page.total_pages }}</div>
    <div class="pagination-controls">
        {% if user_page.page > 1 %}
        <a href="/users?page={{ user_page.page - 1 }}&per_page={{ user_page.per_page }}&sort={{ sort_column }}&dir={{ sort_dir }}&filter={{ filter_json }}" class="btn btn-sm">&#x2190; Previous</a>
        {% else %}
        <span class="btn btn-sm" aria-disabled="true">&#x2190; Previous</span>
        {% endif %}
        <span class="pagination-current">Page {{ user_page.page }} of {{ user_page.total_pages }}</span>
        {% if user_page.page < user_page.total_pages %}
        <a href="/users?page={{ user_page.page + 1 }}&per_page={{ user_page.per_page }}&sort={{ sort_column }}&dir={{ sort_dir }}&filter={{ filter_json }}" class="btn btn-sm">Next &#x2192;</a>
        {% else %}
        <span class="btn btn-sm" aria-disabled="true">Next &#x2192;</span>
        {% endif %}
    </div>
</div>
{% endif %}

<form id="users-bulk-delete-form" method="post" action="/users/bulk-delete" style="display:none">
    <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
    <input type="hidden" id="users-bulk-delete-ids" name="user_ids" value="">
</form>

<script>
function updateBulkToolbar() {
    const checkboxes = document.querySelectorAll('.users-row-checkbox');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const toolbar = document.getElementById('users-bulk-toolbar');
    const countSpan = document.getElementById('users-selected-count');
    const pluralSpan = document.getElementById('users-plural');
    countSpan.textContent = selectedCount;
    pluralSpan.textContent = selectedCount === 1 ? '' : 's';
    toolbar.hidden = selectedCount === 0;
    const selectAll = document.getElementById('users-select-all');
    const total = checkboxes.length;
    selectAll.checked = selectedCount === total && total > 0;
    selectAll.indeterminate = selectedCount > 0 && selectedCount < total;
}

function toggleSelectAll() {
    const checked = document.getElementById('users-select-all').checked;
    document.querySelectorAll('.users-row-checkbox').forEach(cb => cb.checked = checked);
    updateBulkToolbar();
}

function clearSelection() {
    document.querySelectorAll('.users-row-checkbox, #users-select-all').forEach(cb => cb.checked = false);
    updateBulkToolbar();
}

function deleteUser(userId) {
    const row = document.querySelector('[data-user-id="' + userId + '"]');
    const nameEl = row ? row.querySelector('.user-name') : null;
    const displayName = nameEl ? nameEl.textContent.replace('\u{1F464} ', '').trim() : userId;
    if (confirm('Delete user "' + displayName + '"?\n\nThis action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/users/' + userId + '/delete';
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = '{{ ctx.csrf_token }}';
        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmBulkDelete() {
    const checkboxes = document.querySelectorAll('.users-row-checkbox:checked');
    const count = checkboxes.length;
    if (count === 0) { alert('No users selected'); return; }
    if (confirm('Delete ' + count + ' user' + (count !== 1 ? 's' : '') + '?\n\nThis action cannot be undone.')) {
        const ids = Array.from(checkboxes).map(cb => cb.value);
        document.getElementById('users-bulk-delete-ids').value = JSON.stringify(ids);
        document.getElementById('users-bulk-delete-form').submit();
    }
}

updateBulkToolbar();
</script>
{% endblock %}
