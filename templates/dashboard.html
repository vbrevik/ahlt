{% extends "base.html" %}

{% block title %}Dashboard — {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

{# ── Compact greeting ── #}
<div class="dash-header">
    <h1 class="dash-header__greeting">{{ greeting }}</h1>
    <span class="dash-header__role">{{ role_label }}</span>
</div>

{# ── Primary: Needs Attention + My ToRs ── #}
<div class="dash-primary">

    {# Left: Needs Attention #}
    <section class="dash-attention">
        <h2 class="dash-section-title">Needs Attention</h2>

        {% if pending_items.unread_warnings.is_empty() %}
            {% if pending_items.pending_proposals.is_empty() %}
                {% if pending_items.open_suggestions.is_empty() %}
        <p class="dash-empty">Nothing requires your attention right now.</p>
                {% endif %}
            {% endif %}
        {% endif %}

        {# Warnings #}
        {% if !pending_items.unread_warnings.is_empty() %}
        <div class="dash-attention__group">
            <div class="dash-attention__group-header">
                <span class="dash-attention__badge dash-attention__badge--warning">{{ pending_items.unread_warnings.len() }}</span>
                <a href="/warnings" class="dash-attention__group-link">Unread warnings</a>
            </div>
            {% for w in pending_items.unread_warnings %}
            <a href="/warnings/{{ w.warning_id }}" class="dash-attention__item">
                <span class="dash-attention__severity dash-attention__severity--{{ w.severity }}"></span>
                <span class="dash-attention__text">{{ w.message }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {# Pending proposals #}
        {% if !pending_items.pending_proposals.is_empty() %}
        <div class="dash-attention__group">
            <div class="dash-attention__group-header">
                <span class="dash-attention__badge dash-attention__badge--proposal">{{ pending_items.pending_proposals.len() }}</span>
                <span class="dash-attention__group-link">Pending proposals</span>
            </div>
            {% for p in pending_items.pending_proposals %}
            <a href="/workflow" class="dash-attention__item">
                <span class="dash-attention__tag">{{ p.status }}</span>
                <span class="dash-attention__text">{{ p.title }}</span>
                <span class="dash-attention__meta">{{ p.tor_label }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {# Open suggestions #}
        {% if !pending_items.open_suggestions.is_empty() %}
        <div class="dash-attention__group">
            <div class="dash-attention__group-header">
                <span class="dash-attention__badge dash-attention__badge--suggestion">{{ pending_items.open_suggestions.len() }}</span>
                <span class="dash-attention__group-link">Open suggestions</span>
            </div>
            {% for s in pending_items.open_suggestions %}
            <a href="/workflow" class="dash-attention__item">
                <span class="dash-attention__text">{{ s.description_preview }}</span>
                <span class="dash-attention__meta">{{ s.tor_label }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </section>

    {# Right: My ToRs #}
    <section class="dash-mytors">
        <h2 class="dash-section-title">My Terms of Reference</h2>
        {% if user_tors.is_empty() %}
        <p class="dash-empty">You are not assigned to any Terms of Reference.</p>
        {% else %}
        <div class="dash-mytors__list">
            {% for t in user_tors %}
            <a href="/tor/{{ t.tor_id }}" class="dash-mytors__card">
                <span class="dash-mytors__name">{{ t.tor_label }}</span>
                <span class="dash-mytors__position">{{ t.position_label }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </section>

</div>

{# ── Upcoming Meetings ── #}
{% if !upcoming_meetings.is_empty() %}
<section class="dash-meetings">
    <div class="dash-meetings__header">
        <h2 class="dash-section-title">Upcoming Meetings</h2>
        <a href="/tor/outlook" class="dash-link">View calendar &rarr;</a>
    </div>
    <div class="dash-meetings__grid">
        {% for m in upcoming_meetings %}
        <a href="/tor/{{ m.tor_id }}" class="dash-meetings__card">
            <span class="dash-meetings__date">{{ m.date }}</span>
            <span class="dash-meetings__tor">{{ m.tor_label }}</span>
            <span class="dash-meetings__time">{{ m.start_time }} &middot; {{ m.duration_minutes }}min</span>
            {% if !m.location.is_empty() %}
            <span class="dash-meetings__location">{{ m.location }}</span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ── Secondary: System stats + Recent Activity ── #}
<div class="dash-secondary">

    {# Left: Compact stats #}
    <section class="dash-stats">
        <h2 class="dash-section-title">System Overview</h2>
        <div class="dash-stats__grid">
            <a href="/users" class="dash-stats__item">
                <span class="dash-stats__value">{{ user_count }}</span>
                <span class="dash-stats__label">Users</span>
            </a>
            <a href="/roles" class="dash-stats__item">
                <span class="dash-stats__value">{{ role_count }}</span>
                <span class="dash-stats__label">Roles</span>
            </a>
            {% if proposal_count > 0 %}
            <a href="/workflow" class="dash-stats__item dash-stats__item--active">
                <span class="dash-stats__value">{{ proposal_count }}</span>
                <span class="dash-stats__label">Pending</span>
            </a>
            {% endif %}
            <a href="/tor" class="dash-stats__item">
                <span class="dash-stats__value">{{ tor_position_count }}</span>
                <span class="dash-stats__label">Positions</span>
            </a>
            {% if ctx.warning_count > 0 %}
            <a href="/warnings" class="dash-stats__item dash-stats__item--warning">
                <span class="dash-stats__value">{{ ctx.warning_count }}</span>
                <span class="dash-stats__label">Warnings</span>
            </a>
            {% endif %}
        </div>
    </section>

    {# Right: Recent Activity #}
    {% if ctx.permissions.has("audit.view") %}
    <section class="dash-activity">
        <div class="dash-activity__header">
            <h2 class="dash-section-title">Recent Activity</h2>
            <a href="/audit" class="dash-link">View full log &rarr;</a>
        </div>
        {% if recent_activity.is_empty() %}
        <p class="dash-empty">No activity recorded yet.</p>
        {% else %}
        <ul class="dash-activity__list">
            {% for entry in recent_activity %}
            <li class="dash-activity__item">
                <span class="dash-activity__avatar">{{ entry.username.chars().next().unwrap_or('?').to_uppercase().to_string() }}</span>
                <div class="dash-activity__body">
                    <span class="dash-activity__user">{{ entry.username }}</span>
                    <span class="dash-activity__action">{{ entry.summary }}</span>
                </div>
                <time class="dash-activity__time">{{ entry.created_at }}</time>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </section>
    {% endif %}

</div>
{% endblock %}
