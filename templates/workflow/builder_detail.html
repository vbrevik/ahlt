{% extends "base.html" %}

{% block title %}{{ scope }} Workflow â€” {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block sidebar %}
{% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

<div class="page-header">
    <div>
        <a href="/workflow/builder" style="font-size: 0.8125rem; color: var(--text-muted); text-decoration: none;">&larr; All Workflows</a>
        <h1 style="text-transform: capitalize; margin-top: 0.25rem;">{{ scope }} Workflow</h1>
    </div>
</div>

<!-- ============ STATE MACHINE GRAPH ============ -->
{% if !statuses.is_empty() %}
<div class="graph-panel">
    <div class="graph-panel-header">
        <h2>State Machine</h2>
        <span class="graph-panel-stat" id="wfb-graph-stat"></span>
    </div>
    <div class="graph-container" style="height:400px; border:none; border-radius:0;">
        <div class="graph-toolbar" id="wfb-toolbar">
            <button class="btn-icon" id="wfb-btn-fit" title="Fit all (F)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>
            </button>
            <button class="btn-icon" id="wfb-btn-zoom-in" title="Zoom in (+)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </button>
            <button class="btn-icon" id="wfb-btn-zoom-out" title="Zoom out (-)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </button>
            <div class="toolbar-divider"></div>
            <button class="btn-icon" id="wfb-btn-reset" title="Reset zoom (0)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
        </div>
        <div class="graph-canvas" id="wfb-canvas"></div>
    </div>
</div>
{% endif %}

<!-- ============ STATUSES ============ -->
<div class="wfb-section">
    <div class="wfb-section-header">
        <h2>Statuses</h2>
        <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('add-status-form').style.display = document.getElementById('add-status-form').style.display === 'none' ? 'block' : 'none'">
            Add Status
        </button>
    </div>

    <!-- Add status form (hidden by default) -->
    <div id="add-status-form" class="wfb-inline-form" style="display:none;">
        <form method="post" action="/workflow/builder/{{ scope }}/statuses">
            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
            <div class="wfb-form-row">
                <div class="wfb-form-field">
                    <label>Status Code</label>
                    <input type="text" name="status_code" placeholder="e.g. draft" required>
                </div>
                <div class="wfb-form-field">
                    <label>Label</label>
                    <input type="text" name="label" placeholder="e.g. Draft" required>
                </div>
                <div class="wfb-form-field wfb-field-narrow">
                    <label>Order</label>
                    <input type="number" name="order" value="0">
                </div>
                <div class="wfb-form-field wfb-field-check">
                    <label><input type="checkbox" name="is_initial" value="true"> Initial</label>
                </div>
                <div class="wfb-form-field wfb-field-check">
                    <label><input type="checkbox" name="is_terminal" value="true"> Terminal</label>
                </div>
                <div class="wfb-form-field wfb-field-actions">
                    <button type="submit" class="btn btn-sm btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>

    {% if statuses.is_empty() %}
    <div class="empty-state" style="padding: 1.5rem;">
        <p class="empty-state-text">No statuses defined for this workflow.</p>
    </div>
    {% else %}
    <div class="wfb-table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Label</th>
                    <th style="width:60px;">Order</th>
                    <th style="width:100px;">Flags</th>
                    <th style="width:160px; text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for s in statuses %}
                <tr id="status-row-{{ s.id }}">
                    <td>
                        <code class="wfb-code">{{ s.status_code }}</code>
                    </td>
                    <td>{{ s.label }}</td>
                    <td>{{ s.order }}</td>
                    <td>
                        {% if s.is_initial %}<span class="badge badge-success">Initial</span>{% endif %}
                        {% if s.is_terminal %}<span class="badge badge-danger">Terminal</span>{% endif %}
                    </td>
                    <td style="text-align:right;">
                        <button type="button" class="btn btn-sm" onclick="toggleEditStatus({{ s.id }})">Edit</button>
                        <form method="post" action="/workflow/builder/{{ scope }}/statuses/{{ s.id }}/delete"
                              style="display:inline;" onsubmit="return confirm('Delete status {{ s.label }}?')">
                            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                <tr id="status-edit-{{ s.id }}" class="wfb-edit-row" style="display:none;">
                    <td colspan="5">
                        <form method="post" action="/workflow/builder/{{ scope }}/statuses/{{ s.id }}/update">
                            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                            <div class="wfb-form-row">
                                <div class="wfb-form-field">
                                    <label>Label</label>
                                    <input type="text" name="label" value="{{ s.label }}" required>
                                </div>
                                <div class="wfb-form-field wfb-field-narrow">
                                    <label>Order</label>
                                    <input type="number" name="order" value="{{ s.order }}">
                                </div>
                                <div class="wfb-form-field wfb-field-check">
                                    <label><input type="checkbox" name="is_initial" value="true" {% if s.is_initial %}checked{% endif %}> Initial</label>
                                </div>
                                <div class="wfb-form-field wfb-field-check">
                                    <label><input type="checkbox" name="is_terminal" value="true" {% if s.is_terminal %}checked{% endif %}> Terminal</label>
                                </div>
                                <div class="wfb-form-field wfb-field-actions">
                                    <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                    <button type="button" class="btn btn-sm" onclick="toggleEditStatus({{ s.id }})">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- ============ TRANSITIONS ============ -->
<div class="wfb-section">
    <div class="wfb-section-header">
        <h2>Transitions</h2>
        {% if statuses.len() >= 2 %}
        <button type="button" class="btn btn-sm btn-primary" onclick="document.getElementById('add-transition-form').style.display = document.getElementById('add-transition-form').style.display === 'none' ? 'block' : 'none'">
            Add Transition
        </button>
        {% endif %}
    </div>

    <!-- Add transition form (hidden by default) -->
    {% if statuses.len() >= 2 %}
    <div id="add-transition-form" class="wfb-inline-form" style="display:none;">
        <form method="post" action="/workflow/builder/{{ scope }}/transitions">
            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
            <div class="wfb-form-row wfb-form-row-wrap">
                <div class="wfb-form-field">
                    <label>From Status</label>
                    <select name="from_status_id" required>
                        <option value="">Select...</option>
                        {% for s in statuses %}
                        <option value="{{ s.id }}">{{ s.label }} ({{ s.status_code }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="wfb-form-field">
                    <label>To Status</label>
                    <select name="to_status_id" required>
                        <option value="">Select...</option>
                        {% for s in statuses %}
                        <option value="{{ s.id }}">{{ s.label }} ({{ s.status_code }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="wfb-form-field">
                    <label>Label</label>
                    <input type="text" name="label" placeholder="e.g. Submit" required>
                </div>
                <div class="wfb-form-field">
                    <label>Required Permission</label>
                    <select name="required_permission">
                        <option value="">(none)</option>
                        {% for p in permissions %}
                        <option value="{{ p.name }}">{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="wfb-form-field wfb-field-check">
                    <label><input type="checkbox" name="requires_outcome" value="true"> Requires Outcome</label>
                </div>
                <div class="wfb-form-field">
                    <label>Condition</label>
                    <input type="text" name="condition" placeholder="key=value (optional)">
                </div>
                <div class="wfb-form-field wfb-field-actions">
                    <button type="submit" class="btn btn-sm btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    {% if transitions.is_empty() %}
    <div class="empty-state" style="padding: 1.5rem;">
        <p class="empty-state-text">No transitions defined for this workflow.</p>
    </div>
    {% else %}
    <div class="wfb-table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>From</th>
                    <th></th>
                    <th>To</th>
                    <th>Label</th>
                    <th>Permission</th>
                    <th style="width:80px;">Flags</th>
                    <th style="width:160px; text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for t in transitions %}
                <tr>
                    <td><code class="wfb-code">{{ t.from_status_code }}</code></td>
                    <td class="wfb-arrow-cell">&rarr;</td>
                    <td><code class="wfb-code">{{ t.to_status_code }}</code></td>
                    <td><strong>{{ t.transition_label }}</strong></td>
                    <td>
                        {% if t.required_permission.is_empty() %}
                        <span style="color: var(--text-muted);">&mdash;</span>
                        {% else %}
                        <code class="wfb-code wfb-code-perm">{{ t.required_permission }}</code>
                        {% endif %}
                    </td>
                    <td>
                        {% if t.requires_outcome %}<span class="badge badge-warning">Outcome</span>{% endif %}
                        {% if let Some(c) = t.condition %}<span class="badge badge-muted" title="{{ c }}">Cond</span>{% endif %}
                    </td>
                    <td style="text-align:right;">
                        <button type="button" class="btn btn-sm" onclick="toggleEditTransition({{ t.id }})">Edit</button>
                        <form method="post" action="/workflow/builder/{{ scope }}/transitions/{{ t.id }}/delete"
                              style="display:inline;" onsubmit="return confirm('Delete transition {{ t.transition_label }}?')">
                            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                <tr id="transition-edit-{{ t.id }}" class="wfb-edit-row" style="display:none;">
                    <td colspan="7">
                        <form method="post" action="/workflow/builder/{{ scope }}/transitions/{{ t.id }}/update">
                            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                            <div class="wfb-form-row wfb-form-row-wrap">
                                <div class="wfb-form-field">
                                    <label>Label</label>
                                    <input type="text" name="label" value="{{ t.transition_label }}" required>
                                </div>
                                <div class="wfb-form-field">
                                    <label>Required Permission</label>
                                    <select name="required_permission">
                                        <option value="">(none)</option>
                                        {% for p in permissions %}
                                        <option value="{{ p.name }}" {% if p.name.as_str() == t.required_permission.as_str() %}selected{% endif %}>{{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="wfb-form-field wfb-field-check">
                                    <label><input type="checkbox" name="requires_outcome" value="true" {% if t.requires_outcome %}checked{% endif %}> Requires Outcome</label>
                                </div>
                                <div class="wfb-form-field">
                                    <label>Condition</label>
                                    <input type="text" name="condition" value="{% if let Some(c) = t.condition %}{{ c }}{% endif %}" placeholder="key=value">
                                </div>
                                <div class="wfb-form-field wfb-field-actions">
                                    <button type="submit" class="btn btn-sm btn-primary">Save</button>
                                    <button type="button" class="btn btn-sm" onclick="toggleEditTransition({{ t.id }})">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
function toggleEditStatus(id) {
    var row = document.getElementById('status-edit-' + id);
    if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}
function toggleEditTransition(id) {
    var row = document.getElementById('transition-edit-' + id);
    if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}
</script>

<style>
.wfb-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    margin-bottom: 1.5rem;
    overflow: hidden;
}
.wfb-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg-subtle);
}
.wfb-section-header h2 {
    font-size: 1rem;
    margin: 0;
}
.wfb-inline-form {
    padding: 1rem 1.25rem;
    background: var(--accent-subtle);
    border-bottom: 1px solid var(--border);
}
.wfb-form-row {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
}
.wfb-form-row-wrap {
    flex-wrap: wrap;
}
.wfb-form-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
    min-width: 120px;
}
.wfb-form-field label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.wfb-form-field input[type="text"],
.wfb-form-field input[type="number"],
.wfb-form-field select {
    padding: 0.375rem 0.5rem;
    font-size: 0.8125rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--surface);
    font-family: var(--font-body);
}
.wfb-field-narrow {
    max-width: 80px;
    flex: 0 0 80px;
}
.wfb-field-check {
    flex: 0 0 auto;
    min-width: auto;
    justify-content: flex-end;
}
.wfb-field-check label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    text-transform: none;
    letter-spacing: normal;
    white-space: nowrap;
    cursor: pointer;
}
.wfb-field-actions {
    flex: 0 0 auto;
    min-width: auto;
    display: flex;
    gap: 0.375rem;
}
.wfb-table-wrap {
    overflow-x: auto;
}
.wfb-table-wrap .table {
    margin-bottom: 0;
    border: none;
}
.wfb-table-wrap .table th {
    background: transparent;
    border-top: none;
}
.wfb-code {
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    background: var(--bg-subtle);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
}
.wfb-code-perm {
    font-size: 0.75rem;
    color: var(--text-secondary);
}
.wfb-arrow-cell {
    text-align: center;
    color: var(--accent);
    font-weight: 700;
    font-size: 1rem;
    width: 30px;
    padding-left: 0;
    padding-right: 0;
}
.wfb-edit-row td {
    background: var(--accent-subtle);
    border-top: 1px dashed var(--accent);
}
.badge-warning {
    background: #f59e0b;
    color: #fff;
}
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
<script>
(function() {
    var canvas = document.getElementById('wfb-canvas');
    if (!canvas) return;

    /* ---- Data from template ---- */
    var statuses = [
    {% for s in statuses %}
        { id: {{ s.id }}, code: "{{ s.status_code }}", label: "{{ s.label }}", isInitial: {{ s.is_initial }}, isTerminal: {{ s.is_terminal }} },
    {% endfor %}
    ];
    var transitions = [
    {% for t in transitions %}
        { id: {{ t.id }}, fromId: {{ t.from_status_id }}, toId: {{ t.to_status_id }}, label: "{{ t.transition_label }}" },
    {% endfor %}
    ];

    if (!statuses.length) return;

    var statEl = document.getElementById('wfb-graph-stat');
    if (statEl) statEl.textContent = statuses.length + ' states \u00b7 ' + transitions.length + ' transitions';

    /* ---- Colors ---- */
    var CLR_INITIAL  = '#059669';
    var CLR_TERMINAL = '#b91c1c';
    var CLR_NORMAL   = '#b45309';
    var CLR_NODE_BG  = '#ffffff';
    var CLR_BORDER   = '#d6d3d1';
    var CLR_EDGE     = '#78716c';
    var CLR_EDGE_LBL = '#57534e';

    function nodeColor(d) {
        if (d.isInitial) return CLR_INITIAL;
        if (d.isTerminal) return CLR_TERMINAL;
        return CLR_NORMAL;
    }

    /* ---- SVG setup ---- */
    var width  = canvas.clientWidth || 600;
    var height = canvas.clientHeight || 283;

    var svg = d3.select('#wfb-canvas')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', [0, 0, width, height]);

    /* Arrow marker */
    svg.append('defs')
        .append('marker')
        .attr('id', 'wfb-arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 10)
        .attr('refY', 0)
        .attr('markerWidth', 7)
        .attr('markerHeight', 7)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-4L10,0L0,4')
        .attr('fill', CLR_EDGE);

    var g = svg.append('g');

    /* ---- Zoom ---- */
    var zoom = d3.zoom()
        .scaleExtent([0.3, 4])
        .on('zoom', function(e) { g.attr('transform', e.transform); });
    svg.call(zoom);

    function fitAll(animate) {
        var allNodes = g.selectAll('.wfb-gnode');
        if (allNodes.empty()) return;
        var xs = [], ys = [];
        allNodes.each(function(d) { xs.push(d.x); ys.push(d.y); });
        if (!xs.length) return;
        var pad = 60;
        var nodeW = 140, nodeH = 48;
        var x0 = Math.min.apply(null, xs) - pad - nodeW / 2;
        var y0 = Math.min.apply(null, ys) - pad - nodeH / 2;
        var x1 = Math.max.apply(null, xs) + pad + nodeW / 2;
        var y1 = Math.max.apply(null, ys) + pad + nodeH / 2;
        var bw = x1 - x0, bh = y1 - y0;
        if (bw < 1 || bh < 1) return;
        var scale = Math.min(width / bw, height / bh, 1.8);
        var tx = (width - bw * scale) / 2 - x0 * scale;
        var ty = (height - bh * scale) / 2 - y0 * scale;
        var t = d3.zoomIdentity.translate(tx, ty).scale(scale);
        if (animate) {
            svg.transition().duration(500).call(zoom.transform, t);
        } else {
            svg.call(zoom.transform, t);
        }
    }

    /* ---- Toolbar ---- */
    document.getElementById('wfb-btn-fit').addEventListener('click', function() { fitAll(true); });
    document.getElementById('wfb-btn-reset').addEventListener('click', function() {
        svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
    });
    document.getElementById('wfb-btn-zoom-in').addEventListener('click', function() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.5);
    });
    document.getElementById('wfb-btn-zoom-out').addEventListener('click', function() {
        svg.transition().duration(300).call(zoom.scaleBy, 1 / 1.5);
    });

    /* Keyboard shortcuts (matches governance map) */
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
        switch (e.key.toLowerCase()) {
            case 'f': fitAll(true); break;
            case '0': svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity); break;
            case '=': case '+': svg.transition().duration(300).call(zoom.scaleBy, 1.5); break;
            case '-': svg.transition().duration(300).call(zoom.scaleBy, 1 / 1.5); break;
        }
    });

    /* ---- Dagre layout ---- */
    var dagreGraph = new dagre.graphlib.Graph();
    dagreGraph.setGraph({
        rankdir: 'LR',
        nodesep: 30,
        ranksep: 80,
        marginx: 30,
        marginy: 30
    });
    dagreGraph.setDefaultEdgeLabel(function() { return {}; });

    var nodeW = 140, nodeH = 48;
    statuses.forEach(function(s) {
        dagreGraph.setNode(String(s.id), { width: nodeW, height: nodeH });
    });
    transitions.forEach(function(t) {
        dagreGraph.setEdge(String(t.fromId), String(t.toId));
    });

    dagre.layout(dagreGraph);

    /* Read positions back */
    var nodeMap = {};
    statuses.forEach(function(s) {
        var pos = dagreGraph.node(String(s.id));
        s.x = pos.x;
        s.y = pos.y;
        nodeMap[s.id] = s;
    });

    /* ---- Draw edges ---- */
    var edgeGroup = g.append('g');
    var line = d3.line().curve(d3.curveBasis);

    transitions.forEach(function(t) {
        var dagreEdge = dagreGraph.edge(String(t.fromId), String(t.toId));
        if (!dagreEdge) return;
        var points = dagreEdge.points.map(function(p) { return [p.x, p.y]; });

        edgeGroup.append('path')
            .attr('d', line(points))
            .attr('fill', 'none')
            .attr('stroke', CLR_EDGE)
            .attr('stroke-width', 1.6)
            .attr('marker-end', 'url(#wfb-arrow)')
            .attr('opacity', 0.7);

        /* Edge label at midpoint */
        var mid = points[Math.floor(points.length / 2)];
        edgeGroup.append('text')
            .attr('x', mid[0])
            .attr('y', mid[1] - 7)
            .attr('text-anchor', 'middle')
            .attr('font-size', 9.5)
            .attr('fill', CLR_EDGE_LBL)
            .attr('font-family', 'var(--font-mono)')
            .text(t.label);
    });

    /* ---- Draw nodes ---- */
    var nodeGroup = g.selectAll('.wfb-gnode')
        .data(statuses)
        .join('g')
        .attr('class', 'wfb-gnode')
        .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });

    /* Rounded rect with colored left accent bar */
    nodeGroup.append('rect')
        .attr('x', -nodeW / 2)
        .attr('y', -nodeH / 2)
        .attr('width', nodeW)
        .attr('height', nodeH)
        .attr('rx', 6)
        .attr('ry', 6)
        .attr('fill', CLR_NODE_BG)
        .attr('stroke', CLR_BORDER)
        .attr('stroke-width', 1);

    /* Left accent bar */
    nodeGroup.append('rect')
        .attr('x', -nodeW / 2)
        .attr('y', -nodeH / 2)
        .attr('width', 4)
        .attr('height', nodeH)
        .attr('rx', 2)
        .attr('fill', function(d) { return nodeColor(d); });

    /* Status label */
    nodeGroup.append('text')
        .attr('x', 0)
        .attr('y', -3)
        .attr('text-anchor', 'middle')
        .attr('font-size', 12)
        .attr('font-weight', 600)
        .attr('fill', 'var(--text)')
        .attr('font-family', 'var(--font-body)')
        .text(function(d) {
            var label = d.label;
            if (label.length > 16) label = label.substring(0, 14) + '\u2026';
            return label;
        });

    /* Status code below */
    nodeGroup.append('text')
        .attr('x', 0)
        .attr('y', 12)
        .attr('text-anchor', 'middle')
        .attr('font-size', 9.5)
        .attr('fill', 'var(--text-muted)')
        .attr('font-family', 'var(--font-mono)')
        .text(function(d) { return d.code; });

    /* Flag badges */
    nodeGroup.each(function(d) {
        var el = d3.select(this);
        if (d.isInitial) {
            el.append('circle')
                .attr('cx', nodeW / 2 - 10)
                .attr('cy', -nodeH / 2 + 10)
                .attr('r', 4)
                .attr('fill', CLR_INITIAL)
                .append('title').text('Initial state');
        }
        if (d.isTerminal) {
            el.append('circle')
                .attr('cx', nodeW / 2 - 10)
                .attr('cy', nodeH / 2 - 10)
                .attr('r', 4)
                .attr('fill', CLR_TERMINAL)
                .append('title').text('Terminal state');
        }
    });

    /* Hover highlight */
    var edgeIndex = {};
    transitions.forEach(function(t) {
        if (!edgeIndex[t.fromId]) edgeIndex[t.fromId] = [];
        if (!edgeIndex[t.toId]) edgeIndex[t.toId] = [];
        edgeIndex[t.fromId].push(t.toId);
        edgeIndex[t.toId].push(t.fromId);
    });

    nodeGroup
        .style('cursor', 'default')
        .on('mouseover', function(event, d) {
            var connected = new Set();
            connected.add(d.id);
            (edgeIndex[d.id] || []).forEach(function(nid) { connected.add(nid); });
            nodeGroup.attr('opacity', function(n) { return connected.has(n.id) ? 1 : 0.25; });
            edgeGroup.selectAll('path').attr('opacity', 0.2);
            edgeGroup.selectAll('text').attr('opacity', 0.2);
            transitions.forEach(function(t, i) {
                if (t.fromId === d.id || t.toId === d.id) {
                    edgeGroup.selectAll('path').filter(function(x, j) { return j === i; }).attr('opacity', 1);
                    edgeGroup.selectAll('text').filter(function(x, j) { return j === i; }).attr('opacity', 1);
                }
            });
            d3.select(this).select('rect').attr('stroke', nodeColor(d)).attr('stroke-width', 2);
        })
        .on('mouseout', function() {
            nodeGroup.attr('opacity', 1);
            edgeGroup.selectAll('path').attr('opacity', 0.7);
            edgeGroup.selectAll('text').attr('opacity', 1);
            d3.select(this).select('rect').attr('stroke', CLR_BORDER).attr('stroke-width', 1);
        });

    /* Fit on load */
    setTimeout(function() { fitAll(false); }, 50);
})();
</script>
{% endblock %}
