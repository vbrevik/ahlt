{# templates/partials/table_filter.html #}
{# Receives from parent: filter_json, fields_json, sort_column, sort_dir, user_page #}
<div class="filter-builder" id="filter-builder">
    <div class="filter-builder__header">
        <span class="filter-builder__title">Filters</span>
        <div class="filter-builder__root-logic">
            Match
            <select class="filter-logic-select" id="root-logic-select">
                <option value="and">ALL</option>
                <option value="or">ANY</option>
            </select>
            of the following
        </div>
        <div class="filter-builder__header-actions">
            <button type="button" class="btn btn-sm" id="add-root-condition">+ Condition</button>
            <button type="button" class="btn btn-sm" id="add-group">+ Group</button>
        </div>
    </div>

    <div class="filter-builder__conditions" id="root-conditions"></div>
    <div class="filter-builder__groups" id="root-groups"></div>

    <div class="filter-builder__footer">
        <a href="/users" class="btn btn-sm">Clear</a>
        <button type="button" class="btn btn-sm btn-primary" id="apply-filter">Apply &#9658;</button>
    </div>
</div>

{# Hidden form that GET-submits with serialized filter #}
<form method="get" action="/users" id="filter-form" style="display:none">
    <input type="hidden" name="filter" id="filter-json-input">
    <input type="hidden" name="sort" value="{{ sort_column }}">
    <input type="hidden" name="dir" value="{{ sort_dir }}">
    <input type="hidden" name="per_page" value="{{ user_page.per_page }}">
</form>

<script>
(function() {
    var FIELDS = JSON.parse(document.getElementById('filter-fields-json').textContent);
    var stateEl = document.getElementById('filter-state-json');
    var state;
    try { state = JSON.parse(stateEl ? stateEl.textContent : '{}'); }
    catch(e) { state = { logic: 'and', conditions: [], groups: [] }; }

    var OP_LABELS = {
        contains: 'contains', not_contains: 'does not contain', equals: 'equals',
        not_equals: 'not equals', starts_with: 'starts with',
        is: 'is', is_not: 'is not', before: 'before', after: 'after', on: 'on'
    };

    function el(tag, cls, text) {
        var e = document.createElement(tag);
        if (cls) e.className = cls;
        if (text !== undefined) e.textContent = text;
        return e;
    }

    function makeFieldSelect(selected) {
        var s = el('select', 'filter-field-select');
        FIELDS.forEach(function(f) {
            var o = el('option', '', f.label);
            o.value = f.key;
            if (f.key === selected) o.selected = true;
            s.appendChild(o);
        });
        return s;
    }

    function makeOpSelect(fieldKey, selectedOp) {
        var field = FIELDS.find(function(f) { return f.key === fieldKey; }) || FIELDS[0];
        var s = el('select', 'filter-op-select');
        (field.ops || []).forEach(function(op) {
            var o = el('option', '', OP_LABELS[op] || op);
            o.value = op;
            if (op === selectedOp) o.selected = true;
            s.appendChild(o);
        });
        return s;
    }

    function makeValueInput(fieldKey, value) {
        var field = FIELDS.find(function(f) { return f.key === fieldKey; }) || FIELDS[0];
        if (field.type === 'select') {
            var s = el('select', 'filter-value-select');
            (field.options || []).forEach(function(opt) {
                var o = el('option', '', opt.label);
                o.value = opt.value;
                if (opt.value === value) o.selected = true;
                s.appendChild(o);
            });
            return s;
        } else if (field.type === 'date') {
            var inp = el('input', 'filter-value-input');
            inp.type = 'date';
            inp.value = value || '';
            return inp;
        } else {
            var inp = el('input', 'filter-value-input');
            inp.type = 'text';
            inp.placeholder = 'Value...';
            inp.value = value || '';
            return inp;
        }
    }

    function makeConditionRow(container, cond) {
        var row = el('div', 'filter-condition-row');
        var fieldSel = makeFieldSelect(cond.field || (FIELDS[0] && FIELDS[0].key));
        var opSel = makeOpSelect(fieldSel.value, cond.op);
        var valInp = makeValueInput(fieldSel.value, cond.value);
        var removeBtn = el('button', 'filter-remove-btn', '\u2715');
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', 'Remove condition');

        fieldSel.addEventListener('change', function() {
            var newOp = makeOpSelect(fieldSel.value, '');
            var newVal = makeValueInput(fieldSel.value, '');
            row.replaceChild(newOp, opSel);
            row.replaceChild(newVal, valInp);
            opSel = newOp;
            valInp = newVal;
        });

        removeBtn.addEventListener('click', function() { row.remove(); });

        row.appendChild(fieldSel);
        row.appendChild(opSel);
        row.appendChild(valInp);
        row.appendChild(removeBtn);
        container.appendChild(row);
    }

    function makeGroup(groupState) {
        var wrapper = el('div', 'filter-group');
        var header = el('div', 'filter-group__header');
        var logicLabel = el('span', 'filter-group__label', 'Match ');
        var logicSel = el('select', 'filter-logic-select');
        [['and','ALL'],['or','ANY']].forEach(function(pair) {
            var o = el('option', '', pair[1]);
            o.value = pair[0];
            if (pair[0] === (groupState.logic || 'and')) o.selected = true;
            logicSel.appendChild(o);
        });
        var logicSuffix = el('span', 'filter-group__label', ' of:');
        var addCondBtn = el('button', 'btn btn-sm', '+ Condition');
        addCondBtn.type = 'button';
        var removeGroupBtn = el('button', 'filter-remove-btn', '\u2715 Group');
        removeGroupBtn.type = 'button';

        header.appendChild(logicLabel);
        header.appendChild(logicSel);
        header.appendChild(logicSuffix);
        header.appendChild(addCondBtn);
        header.appendChild(removeGroupBtn);

        var condContainer = el('div', 'filter-group__conditions');
        (groupState.conditions || []).forEach(function(c) { makeConditionRow(condContainer, c); });

        addCondBtn.addEventListener('click', function() {
            makeConditionRow(condContainer, { field: FIELDS[0] && FIELDS[0].key, op: '', value: '' });
        });
        removeGroupBtn.addEventListener('click', function() { wrapper.remove(); });

        wrapper.appendChild(header);
        wrapper.appendChild(condContainer);
        return wrapper;
    }

    function readConditions(container) {
        return Array.from(container.querySelectorAll('.filter-condition-row')).map(function(row) {
            var selects = row.querySelectorAll('select');
            var valueEl = row.querySelector('.filter-value-input, .filter-value-select');
            return {
                field: selects[0] ? selects[0].value : '',
                op: selects[1] ? selects[1].value : '',
                value: valueEl ? valueEl.value : ''
            };
        }).filter(function(c) { return c.field && c.value !== ''; });
    }

    function collectState() {
        var rootLogic = document.getElementById('root-logic-select').value;
        var rootConds = readConditions(document.getElementById('root-conditions'));
        var groups = Array.from(document.getElementById('root-groups').querySelectorAll('.filter-group')).map(function(g) {
            var logic = g.querySelector('.filter-logic-select').value;
            var conds = readConditions(g.querySelector('.filter-group__conditions'));
            return { logic: logic, conditions: conds };
        }).filter(function(g) { return g.conditions.length > 0; });
        return { logic: rootLogic, conditions: rootConds, groups: groups };
    }

    // Render initial state
    var rootLogicSel = document.getElementById('root-logic-select');
    if (rootLogicSel && state.logic) rootLogicSel.value = state.logic;
    var rootConds = document.getElementById('root-conditions');
    (state.conditions || []).forEach(function(c) { makeConditionRow(rootConds, c); });
    var rootGroups = document.getElementById('root-groups');
    (state.groups || []).forEach(function(g) { rootGroups.appendChild(makeGroup(g)); });

    document.getElementById('add-root-condition').addEventListener('click', function() {
        makeConditionRow(rootConds, { field: FIELDS[0] && FIELDS[0].key, op: '', value: '' });
    });

    document.getElementById('add-group').addEventListener('click', function() {
        var newGroup = makeGroup({ logic: 'or', conditions: [] });
        rootGroups.appendChild(newGroup);
        makeConditionRow(newGroup.querySelector('.filter-group__conditions'), { field: FIELDS[0] && FIELDS[0].key, op: '', value: '' });
    });

    document.getElementById('apply-filter').addEventListener('click', function() {
        var tree = collectState();
        var isEmpty = tree.conditions.length === 0 && tree.groups.length === 0;
        document.getElementById('filter-json-input').value = isEmpty ? '' : JSON.stringify(tree);
        document.getElementById('filter-form').submit();
    });
})();
</script>
