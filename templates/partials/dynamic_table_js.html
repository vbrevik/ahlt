<script>
/**
 * Shared dynamic table editor lifecycle.
 *
 * config: {
 *   tableBodyId      - ID of the <tbody> element
 *   dataId           - ID of the <script type="application/json"> element
 *   addBtnId         - ID of the "add row" button (also used for canEdit detection)
 *   saveBtnId        - ID of the save/submit button (used to find parent <form>)
 *   hiddenInputId    - ID of the hidden <input> that receives serialized JSON
 *   makeRow(item, canEdit) - returns a <tr> for the given data item
 *   serializeRow(tr)       - returns a plain object from a <tr>, or null to skip
 * }
 */
function createDynamicTable(config) {
    var data = JSON.parse(
        (document.getElementById(config.dataId) || {}).textContent || '[]'
    );
    var canEdit = !!document.getElementById(config.addBtnId);
    var tbody = document.getElementById(config.tableBodyId);

    // Load existing rows
    data.forEach(function(item) {
        tbody.appendChild(config.makeRow(item, canEdit));
    });

    // Add-row handler
    if (canEdit) {
        var addBtn = document.getElementById(config.addBtnId);
        if (addBtn) {
            addBtn.addEventListener('click', function() {
                tbody.appendChild(config.makeRow({}, canEdit));
            });
        }
    }

    // Serialize on form submit
    var saveBtn = document.getElementById(config.saveBtnId);
    if (saveBtn) {
        saveBtn.closest('form').addEventListener('submit', function() {
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var items = rows.map(function(tr) {
                return config.serializeRow(tr);
            }).filter(function(obj) { return obj !== null; });
            document.getElementById(config.hiddenInputId).value = JSON.stringify(items);
        });
    }
}
</script>
