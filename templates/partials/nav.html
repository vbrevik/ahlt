<nav class="navbar">
    <div class="navbar-brand">
        <a href="/dashboard">{{ ctx.app_name }}</a>
    </div>
    <div class="navbar-center">
        {% for m in ctx.nav_modules %}
        <a href="{{ m.url }}"{% if m.is_active %} class="active"{% endif %}>{{ m.label }}</a>
        {% endfor %}
    </div>
    <div class="navbar-end">
        <div class="theme-toggle-container">
            <button id="theme-toggle" class="theme-toggle-btn" title="Toggle dark mode" aria-label="Toggle dark mode">
                <span class="theme-icon">ðŸŒ™</span>
            </button>
        </div>
        <div class="user-dropdown">
            <button class="avatar-btn" type="button" onclick="this.parentElement.classList.toggle('open')">
                <span class="avatar">
                    {{ ctx.avatar_initial }}
                    {% if ctx.warning_count > 0 %}
                    <span class="avatar-badge">{{ ctx.warning_count }}</span>
                    {% endif %}
                </span>
            </button>
            <div class="dropdown-panel">
                <div class="dropdown-header">{{ ctx.username }}</div>
                <a href="/account" class="dropdown-item">Profile</a>
                <a href="/warnings" class="dropdown-item">
                    Warnings
                    {% if ctx.warning_count > 0 %}
                    <span class="badge-count">{{ ctx.warning_count }}</span>
                    {% endif %}
                </a>
                <div class="dropdown-divider"></div>
                <form method="post" action="/logout" class="dropdown-item-form">
                    <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                    <button type="submit" class="dropdown-item dropdown-item-danger">Logout</button>
                </form>
            </div>
        </div>
    </div>
</nav>
<script>
document.addEventListener('click', function(e) {
    document.querySelectorAll('.user-dropdown.open').forEach(function(d) {
        if (!d.contains(e.target)) d.classList.remove('open');
    });
});

// WebSocket for real-time warning notifications
(function() {
    var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    var ws = null;
    var retryDelay = 1000;

    function connect() {
        ws = new WebSocket(proto + '//' + location.host + '/ws/notifications');

        ws.onopen = function() {
            retryDelay = 1000;
        };

        ws.onmessage = function(evt) {
            try {
                var data = JSON.parse(evt.data);
                if (data.type === 'count_update' || data.type === 'new_warning') {
                    updateBadge(data.unread_count);
                }
                if (data.type === 'new_warning') {
                    showToast(data.severity, data.title);
                }
            } catch(e) {}
        };

        ws.onclose = function() {
            setTimeout(function() {
                retryDelay = Math.min(retryDelay * 2, 30000);
                connect();
            }, retryDelay);
        };
    }

    function updateBadge(count) {
        // Avatar badge
        var avatarBadge = document.querySelector('.avatar-badge');
        if (count > 0) {
            if (!avatarBadge) {
                avatarBadge = document.createElement('span');
                avatarBadge.className = 'avatar-badge';
                document.querySelector('.avatar').appendChild(avatarBadge);
            }
            avatarBadge.textContent = count;
        } else if (avatarBadge) {
            avatarBadge.remove();
        }
        // Dropdown badge
        var dropBadge = document.querySelector('.dropdown-item .badge-count');
        if (count > 0) {
            if (dropBadge) dropBadge.textContent = count;
        } else if (dropBadge) {
            dropBadge.remove();
        }
    }

    function showToast(severity, title) {
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + severity;
        toast.textContent = title;
        var container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }
        container.appendChild(toast);
        setTimeout(function() { toast.classList.add('show'); }, 10);
        setTimeout(function() {
            toast.classList.remove('show');
            setTimeout(function() { toast.remove(); }, 300);
        }, 5000);
    }

    connect();
})();
</script>
