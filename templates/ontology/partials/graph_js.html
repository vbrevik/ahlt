<script src="https://d3js.org/d3.v7.min.js"></script>
{% include "partials/graph_toolkit_js.html" %}
<script>
(function() {
    var TYPE_COLORS = {
        'nav_item':      '#0d9488',
        'permission':    '#059669',
        'relation_type': '#7c3aed',
        'role':          '#2563eb',
        'user':          '#d97706',
        'setting':       '#e11d48'
    };
    var FALLBACK_COLOR = '#78716c';

    function typeColor(t) { return TYPE_COLORS[t] || FALLBACK_COLOR; }

    function createEl(tag, attrs, text) {
        var el = document.createElement(tag);
        if (attrs) Object.keys(attrs).forEach(function(k) {
            if (k === 'style' && typeof attrs[k] === 'object') {
                Object.keys(attrs[k]).forEach(function(s) { el.style[s] = attrs[k][s]; });
            } else { el.setAttribute(k, attrs[k]); }
        });
        if (text) el.textContent = text;
        return el;
    }

    var canvas = document.getElementById('graph-canvas');
    var loading = document.getElementById('graph-loading');
    var detail = document.getElementById('graph-detail');
    var statEl = document.getElementById('toolbar-stat');

    var width = canvas.clientWidth;
    var height = canvas.clientHeight || 600;

    var svg = d3.select('#graph-canvas')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', [0, 0, width, height]);

    // Arrow marker for directed edges
    svg.append('defs').selectAll('marker')
        .data(['schema-arrow'])
        .join('marker')
        .attr('id', 'schema-arrow')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 32)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', 'var(--text-muted)');

    var g = svg.append('g');

    var zoom = d3.zoom()
        .scaleExtent([0.2, 5])
        .on('zoom', function(e) { g.attr('transform', e.transform); });
    svg.call(zoom);

    // Shared state
    var simulation, linkGroup, nodeGroup, edgeLabelGroup;
    var allNodes = [], allLinks = [];
    var locked = false;

    // Initialize shared graph toolkit
    var toolkit = graphToolkit({
        svg: svg,
        zoomBehavior: zoom,
        width: width,
        height: height,
        getNodePositions: function() {
            return {
                xs: allNodes.map(function(n) { return n.x; }),
                ys: allNodes.map(function(n) { return n.y; })
            };
        },
        fitPadding: { top: 60, right: 80, bottom: 80, left: 80 },
        maxScale: 1.8
    });

    // Toolbar buttons (shared)
    toolkit.setupToolbar({
        fit: 'btn-fit',
        reset: 'btn-reset',
        zoomIn: 'btn-zoom-in',
        zoomOut: 'btn-zoom-out'
    });

    // Lock button (ontology-specific)
    var lockBtn = document.getElementById('btn-lock');
    lockBtn.addEventListener('click', function() {
        locked = !locked;
        lockBtn.classList.toggle('active', locked);
        lockBtn.title = locked ? 'Unlock positions (L)' : 'Lock positions (L)';
        if (locked) {
            allNodes.forEach(function(n) { n.fx = n.x; n.fy = n.y; });
            if (simulation) simulation.alphaTarget(0).alpha(0);
        } else {
            allNodes.forEach(function(n) { n.fx = null; n.fy = null; });
            if (simulation) simulation.alphaTarget(0).alpha(0.3).restart();
        }
    });

    // Keyboard shortcuts (shared + ontology-specific extras)
    toolkit.setupKeyboardShortcuts(function(e) {
        switch (e.key.toLowerCase()) {
            case 'l':
                lockBtn.click();
                break;
            case 'escape':
                dismissContextMenu();
                detail.style.display = 'none';
                break;
        }
    });

    var FETCH_TIMEOUT_MS = 30000;
    fetch('/ontology/api/schema', { signal: AbortSignal.timeout(FETCH_TIMEOUT_MS) })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            render(data);
        })
        .catch(function(e) {
            loading.style.display = 'none';
            var msg = (e.name === 'TimeoutError' || e.name === 'AbortError')
                ? 'Request timed out. Please refresh to retry.'
                : 'Failed to load graph data.';
            canvas.textContent = msg;
        });

    function render(data) {
        var nodes = data.nodes;
        var edges = data.edges;
        allNodes = nodes;

        statEl.textContent = nodes.length + ' types \u00b7 ' + edges.length + ' relations';

        var nodeMap = new Map(nodes.map(function(n) { return [n.id, n]; }));
        var links = edges.map(function(e) {
            return {
                source: nodeMap.get(e.source),
                target: nodeMap.get(e.target),
                relation_type: e.relation_type,
                relation_label: e.relation_label,
                count: e.count
            };
        }).filter(function(l) { return l.source && l.target; });
        allLinks = links;

        // Links
        linkGroup = g.append('g').attr('class', 'links')
            .selectAll('line')
            .data(links)
            .join('line')
            .attr('stroke', 'var(--border-strong)')
            .attr('stroke-width', function(d) { return Math.max(1.5, Math.min(4, d.count)); })
            .attr('stroke-opacity', 0.5)
            .attr('marker-end', 'url(#schema-arrow)');

        // Edge labels
        edgeLabelGroup = g.append('g').attr('class', 'edge-labels')
            .selectAll('text')
            .data(links)
            .join('text')
            .text(function(d) { return d.relation_type + ' (' + d.count + ')'; })
            .attr('font-size', 10)
            .attr('fill', 'var(--text-muted)')
            .attr('text-anchor', 'middle')
            .attr('dy', -6)
            .style('pointer-events', 'none')
            .style('font-family', 'var(--font-mono)');

        // Node groups (circle + label)
        nodeGroup = g.append('g').attr('class', 'nodes')
            .selectAll('g')
            .data(nodes)
            .join('g')
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragStart)
                .on('drag', dragging)
                .on('end', dragEnd))
            .on('mouseover', function(event, d) { highlightNode(d); })
            .on('mouseout', function() { unhighlight(); })
            .on('click', function(event, d) { showDetail(d); })
            .on('contextmenu', function(event, d) { showContextMenu(event, d); });

        // Node circles â€” radius based on instance count
        nodeGroup.append('circle')
            .attr('r', function(d) { return Math.max(18, Math.min(40, 12 + d.count * 2)); })
            .attr('fill', function(d) { return typeColor(d.id); })
            .attr('stroke', '#fff')
            .attr('stroke-width', 3)
            .attr('opacity', 0.9);

        // Count badge inside circle
        nodeGroup.append('text')
            .text(function(d) { return d.count; })
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .attr('font-size', 13)
            .attr('font-weight', 700)
            .attr('fill', '#fff')
            .style('pointer-events', 'none')
            .style('font-family', 'var(--font-mono)');

        // Label below circle
        nodeGroup.append('text')
            .text(function(d) { return d.label; })
            .attr('text-anchor', 'middle')
            .attr('dy', function(d) { return Math.max(18, Math.min(40, 12 + d.count * 2)) + 16; })
            .attr('font-size', 13)
            .attr('font-weight', 600)
            .attr('fill', 'var(--text)')
            .style('pointer-events', 'none')
            .style('font-family', 'var(--font-body)');

        var autoFitted = false;
        simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(function(d) { return d.id; }).distance(160))
            .force('charge', d3.forceManyBody().strength(-350))
            .force('x', d3.forceX(width / 2).strength(0.12))
            .force('y', d3.forceY(height / 2).strength(0.12))
            .force('collision', d3.forceCollide(55))
            .on('tick', function() {
                linkGroup
                    .attr('x1', function(d) { return d.source.x; })
                    .attr('y1', function(d) { return d.source.y; })
                    .attr('x2', function(d) { return d.target.x; })
                    .attr('y2', function(d) { return d.target.y; });
                edgeLabelGroup
                    .attr('x', function(d) { return (d.source.x + d.target.x) / 2; })
                    .attr('y', function(d) { return (d.source.y + d.target.y) / 2; });
                nodeGroup.attr('transform', function(d) {
                    return 'translate(' + d.x + ',' + d.y + ')';
                });
                // Auto-fit once simulation has mostly settled
                if (!autoFitted && simulation.alpha() < 0.05) {
                    autoFitted = true;
                    toolkit.fitToView(true);
                }
            });

        function dragStart(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragging(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragEnd(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (!locked) { d.fx = null; d.fy = null; }
        }
    }

    function highlightNode(d) {
        var connected = new Set();
        connected.add(d.id);
        linkGroup.each(function(l) {
            if (l.source.id === d.id || l.target.id === d.id) {
                connected.add(l.source.id);
                connected.add(l.target.id);
            }
        });
        nodeGroup.attr('opacity', function(n) { return connected.has(n.id) ? 1 : 0.2; });
        linkGroup.attr('stroke-opacity', function(l) {
            return (l.source.id === d.id || l.target.id === d.id) ? 0.8 : 0.05;
        });
        edgeLabelGroup.attr('opacity', function(l) {
            return (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1;
        });
    }

    function unhighlight() {
        nodeGroup.attr('opacity', 1);
        linkGroup.attr('stroke-opacity', 0.5);
        edgeLabelGroup.attr('opacity', 1);
    }

    function showDetail(d) {
        detail.style.display = '';
        var detailType = document.getElementById('detail-type');
        detailType.textContent = 'ENTITY TYPE';
        detailType.style.color = typeColor(d.id);
        document.getElementById('detail-label').textContent = d.label;
        document.getElementById('detail-meta').textContent = d.count + ' instance' + (d.count !== 1 ? 's' : '');

        var propsEl = document.getElementById('detail-props');
        while (propsEl.firstChild) propsEl.removeChild(propsEl.firstChild);
        if (d.property_keys && d.property_keys.length > 0) {
            propsEl.appendChild(createEl('span', { 'class': 'conn-heading' }, 'Properties'));
            d.property_keys.forEach(function(key) {
                var row = createEl('div', { 'class': 'conn-row' });
                row.appendChild(createEl('code', null, key));
                propsEl.appendChild(row);
            });
        }

        var connEl = document.getElementById('detail-connections');
        while (connEl.firstChild) connEl.removeChild(connEl.firstChild);

        var outgoing = allLinks.filter(function(l) { return l.source.id === d.id; });
        var incoming = allLinks.filter(function(l) { return l.target.id === d.id; });

        if (outgoing.length) {
            connEl.appendChild(createEl('span', { 'class': 'conn-heading' }, 'Outgoing Relations'));
            outgoing.forEach(function(l) {
                var row = createEl('div', { 'class': 'conn-row' });
                row.appendChild(createEl('code', null, l.relation_type));
                row.appendChild(document.createTextNode(' \u2192 '));
                var name = createEl('span', null, l.target.label);
                name.style.color = typeColor(l.target.id);
                name.style.fontWeight = '600';
                row.appendChild(name);
                row.appendChild(createEl('span', { 'class': 'conn-count' }, ' (' + l.count + ')'));
                connEl.appendChild(row);
            });
        }
        if (incoming.length) {
            connEl.appendChild(createEl('span', { 'class': 'conn-heading' }, 'Incoming Relations'));
            incoming.forEach(function(l) {
                var row = createEl('div', { 'class': 'conn-row' });
                var name = createEl('span', null, l.source.label);
                name.style.color = typeColor(l.source.id);
                name.style.fontWeight = '600';
                row.appendChild(name);
                row.appendChild(document.createTextNode(' \u2192 '));
                row.appendChild(createEl('code', null, l.relation_type));
                row.appendChild(createEl('span', { 'class': 'conn-count' }, ' (' + l.count + ')'));
                connEl.appendChild(row);
            });
        }
        if (!outgoing.length && !incoming.length) {
            connEl.appendChild(createEl('span', { 'class': 'conn-empty' }, 'No relations'));
        }
    }

    // Context menu
    var contextMenuEl = null;
    var containerEl = document.querySelector('.graph-container');

    function dismissContextMenu() {
        if (contextMenuEl) { contextMenuEl.remove(); contextMenuEl = null; }
    }

    document.addEventListener('click', function(e) {
        if (contextMenuEl && !contextMenuEl.contains(e.target)) dismissContextMenu();
    });

    function showContextMenu(event, d) {
        event.preventDefault();
        dismissContextMenu();
        var menu = createEl('div', { 'class': 'context-menu' });

        // Header: type label + instance count badge
        var header = createEl('div', { 'class': 'context-menu__header' });
        var headerLabel = createEl('span', { 'class': 'context-menu__header-label' }, d.label);
        var headerBadge = createEl('span', { 'class': 'context-menu__header-badge' }, d.count + ' instance' + (d.count !== 1 ? 's' : ''));
        headerBadge.style.color = typeColor(d.id);
        header.appendChild(headerLabel);
        header.appendChild(headerBadge);
        menu.appendChild(header);
        menu.appendChild(createEl('div', { 'class': 'context-menu__divider' }));

        // "View instances" action
        var viewAction = createEl('div', { 'class': 'context-menu__action' });
        viewAction.appendChild(createEl('span', { 'class': 'context-menu__action-icon' }, '\u2192'));
        viewAction.appendChild(document.createTextNode('View instances'));
        viewAction.addEventListener('click', function() {
            window.location.href = '/ontology/data?type=' + encodeURIComponent(d.id);
        });
        menu.appendChild(viewAction);

        // Relation types this entity type participates in
        var relatedLinks = allLinks.filter(function(l) {
            return l.source.id === d.id || l.target.id === d.id;
        });
        if (relatedLinks.length) {
            menu.appendChild(createEl('div', { 'class': 'context-menu__divider' }));
            var group = createEl('div', { 'class': 'context-menu__group' });
            var groupHeader = createEl('div', { 'class': 'context-menu__group-header' });
            groupHeader.appendChild(createEl('span', { 'class': 'context-menu__group-toggle' }, '\u25BE'));
            groupHeader.appendChild(document.createTextNode(' Relation types'));
            groupHeader.addEventListener('click', function() {
                group.classList.toggle('collapsed');
            });
            group.appendChild(groupHeader);
            var itemsContainer = createEl('div', { 'class': 'context-menu__group-items' });
            relatedLinks.forEach(function(l) {
                var item = createEl('div', { 'class': 'context-menu__item' });
                item.appendChild(createEl('span', null, l.relation_type + ' (' + l.count + ')'));
                itemsContainer.appendChild(item);
            });
            group.appendChild(itemsContainer);
            menu.appendChild(group);
        }

        // Position relative to container
        var rect = containerEl.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        containerEl.appendChild(menu);
        contextMenuEl = menu;

        // Flip if near edges
        requestAnimationFrame(function() {
            var menuRect = menu.getBoundingClientRect();
            if (menuRect.right > rect.right - 10) menu.style.left = (x - menuRect.width) + 'px';
            if (menuRect.bottom > rect.bottom - 10) menu.style.top = (y - menuRect.height) + 'px';
        });
    }

    document.getElementById('btn-close-detail').addEventListener('click', function() {
        detail.style.display = 'none';
    });
})();
</script>
