{% extends "base.html" %}

{% block title %}{{ agenda_point.title }} — {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block sidebar %}
{% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

<div class="page-header">
    <h1>{{ agenda_point.title }}</h1>
    <div class="page-actions">
        <a href="/tor/{{ tor_id }}/workflow?tab=agenda_points" class="btn btn-sm">Back to Workflow</a>
    </div>
</div>

<div class="point-paper-grid">

<!-- ── Left column: document content ── -->
<div class="point-paper-body">

    {% if !agenda_point.description.is_empty() %}
    <div class="point-paper-desc">{{ agenda_point.description }}</div>
    {% endif %}

    <!-- COA comparison grid -->
    {% if !coas.is_empty() %}
    <section class="section">
        <div class="section-header">
            <h2>Courses of Action</h2>
        </div>
        <div class="coa-grid">
            {% for coa in coas %}
            <div class="coa-comparison-card">
                <div class="coa-comparison-card-title">{{ coa.title }}</div>

                <!-- Preference bar: find matching opinion summary by coa_id -->
                {% for summary in opinions %}
                {% if summary.coa_id == coa.id %}
                <div class="coa-pref">
                    <div class="coa-pref-bar-track">
                        <div class="coa-pref-bar-fill" style="width: {{ summary.preference_pct }}%"></div>
                    </div>
                    {% if summary.preference_count == 1 %}
                    <span class="coa-pref-count">1 prefer</span>
                    {% else %}
                    <span class="coa-pref-count">{{ summary.preference_count }} prefer</span>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}

                <div class="coa-card-footer">
                    <span class="badge badge-muted">
                        {% if coa.coa_type.as_str() == "complex" %}Complex{% else %}Simple{% endif %}
                    </span>
                    {% if ctx.permissions.has("agenda.manage") %}
                    <a href="/tor/{{ tor_id }}/workflow/agenda/{{ agenda_point.id }}/coa/{{ coa.id }}/edit" class="coa-card-link">View details &#x2192;</a>
                    {% endif %}
                </div>

                {% if !coa.description.is_empty() %}
                <p class="coa-card-desc">{{ coa.description }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Opinions — collapsible groups -->
    {% if agenda_point.item_type.as_str() == "decision" %}
    <section class="section">
        <div class="section-header">
            <h2>Member Opinions</h2>
        </div>

        {% if opinions.is_empty() %}
        <p class="empty-hint">No opinions recorded yet.</p>
        {% else %}
        {% for summary in opinions %}
        <details class="opinion-group">
            <summary class="opinion-group-summary">
                <span class="opinion-group-summary-left">
                    <span class="opinion-chevron">&#x25BE;</span>
                    {{ summary.coa_title }}
                </span>
                {% if summary.preference_count == 1 %}
                <span class="badge badge-info">1 member</span>
                {% else %}
                <span class="badge badge-info">{{ summary.preference_count }} members</span>
                {% endif %}
            </summary>
            <div class="opinion-group-body">
                {% for opinion in summary.opinions %}
                <div class="opinion-item">
                    <span class="opinion-member">{{ opinion.recorded_by_name }}</span>
                    {% if !opinion.commentary.is_empty() %}
                    <span class="opinion-commentary">{{ opinion.commentary }}</span>
                    {% else %}
                    <span class="opinion-commentary" style="opacity:0.4">&#x2014;</span>
                    {% endif %}
                    <span class="opinion-date">{{ opinion.created_date }}</span>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
        {% endif %}
    </section>
    {% endif %}

</div><!-- end .point-paper-body -->

<!-- ── Right column: sticky sidebar ── -->
<div class="point-paper-sidebar">
    <div class="point-paper-meta">
        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Status</span>
            <span class="point-paper-meta-value">
                {% if agenda_point.status.as_str() == "draft" %}
                <span class="badge badge-muted">Draft</span>
                {% else if agenda_point.status.as_str() == "scheduled" %}
                <span class="badge badge-info">Scheduled</span>
                {% else if agenda_point.status.as_str() == "presented" %}
                <span class="badge badge-primary">Presented</span>
                {% else if agenda_point.status.as_str() == "decided" %}
                <span class="badge badge-success">Decided</span>
                {% else %}
                <span class="badge badge-muted">{{ agenda_point.status }}</span>
                {% endif %}
            </span>
        </div>

        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Type</span>
            <span class="point-paper-meta-value">
                {% if agenda_point.item_type.as_str() == "decision" %}
                <span class="badge badge-warning">Decision</span>
                {% else %}
                <span class="badge badge-info">Informative</span>
                {% endif %}
            </span>
        </div>

        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Date</span>
            <span class="point-paper-meta-value">{{ agenda_point.scheduled_date }}</span>
        </div>

        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Time</span>
            <span class="point-paper-meta-value">{{ agenda_point.time_allocation_minutes }} min</span>
        </div>

        {% if !agenda_point.presenter.is_empty() %}
        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Presenter</span>
            <span class="point-paper-meta-value">{{ agenda_point.presenter }}</span>
        </div>
        {% endif %}

        {% if !agenda_point.priority.is_empty() %}
        {% if agenda_point.priority.as_str() != "normal" %}
        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Priority</span>
            <span class="point-paper-meta-value">
                {% if agenda_point.priority.as_str() == "urgent" %}
                <span class="badge badge-danger">Urgent</span>
                {% else %}
                <span class="badge badge-warning">High</span>
                {% endif %}
            </span>
        </div>
        {% endif %}
        {% endif %}

        {% if !agenda_point.pre_read_url.is_empty() %}
        <div class="point-paper-meta-row">
            <span class="point-paper-meta-label">Pre-Read</span>
            <span class="point-paper-meta-value">
                <a href="{{ agenda_point.pre_read_url }}" target="_blank" rel="noopener">Open &#x2192;</a>
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Actions section -->
    <div class="point-paper-divider"></div>
    <div class="point-paper-actions">
        <div class="point-paper-actions-label">Actions</div>

        {% if !available_transitions.is_empty() %}
        {% if ctx.permissions.has("agenda.manage") %}
        {% for transition in available_transitions %}
        <form method="post" action="/tor/{{ tor_id }}/workflow/agenda/{{ agenda_point.id }}/transition">
            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
            <input type="hidden" name="to_status" value="{{ transition.to_status_code }}">
            <button type="submit" class="btn btn-sm btn-secondary" style="width:100%">
                {{ transition.transition_label }}
            </button>
        </form>
        {% endfor %}
        {% endif %}
        {% endif %}

        {% if agenda_point.item_type.as_str() == "decision" %}
        {% if ctx.permissions.has("agenda.manage") %}
        <a href="/tor/{{ tor_id }}/workflow/agenda/{{ agenda_point.id }}/coa/new" class="btn btn-sm" style="width:100%;text-align:center">Manage COAs</a>
        {% endif %}
        {% if ctx.permissions.has("agenda.participate") %}
        <a href="/tor/{{ tor_id }}/workflow/agenda/{{ agenda_point.id }}/input" class="btn btn-sm btn-primary" style="width:100%;text-align:center">Record Opinion</a>
        {% endif %}
        {% if ctx.permissions.has("agenda.decide") %}
        {% if agenda_point.status.as_str() != "decided" %}
        <a href="/tor/{{ tor_id }}/workflow/agenda/{{ agenda_point.id }}/decide" class="btn btn-sm btn-primary" style="width:100%;text-align:center">Finalize Decision</a>
        {% endif %}
        {% endif %}
        {% endif %}

        {% if available_transitions.is_empty() %}
        {% if agenda_point.status.as_str() == "decided" %}
        <p class="empty-hint" style="font-size:0.8125rem;margin:0">Decision recorded.</p>
        {% else %}
        <p class="empty-hint" style="font-size:0.8125rem;margin:0">No actions available.</p>
        {% endif %}
        {% endif %}
    </div>
</div><!-- end .point-paper-sidebar -->

</div><!-- end .point-paper-grid -->
{% endblock %}
