{% extends "base.html" %}

{% block title %}{{ meeting.label }} — {{ ctx.app_name }}{% endblock %}

{% block nav %}
{% include "partials/nav.html" %}
{% endblock %}

{% block sidebar %}
{% include "partials/sidebar.html" %}
{% endblock %}

{% block content %}
{% if let Some(msg) = ctx.flash %}
<div class="alert alert-success">{{ msg }}</div>
{% endif %}

<div class="page-header">
    <h1>{{ meeting.label }}</h1>
    <div class="page-actions">
        {% if !transitions.is_empty() %}
        {% for transition in transitions %}
        <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/transition" class="inline">
            <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
            <input type="hidden" name="new_status" value="{{ transition.to_status_code }}">
            <button type="submit" class="btn btn-sm btn-secondary">
                {{ transition.transition_label }}
            </button>
        </form>
        {% endfor %}
        {% endif %}
        <a href="/tor/{{ tor_id }}" class="btn btn-sm">Back to ToR</a>
    </div>
</div>

<!-- Meeting Info -->
<div class="detail-card">
    <div class="detail-row">
        <span class="detail-label">Status</span>
        <span class="detail-value">
            {% if meeting.status.as_str() == "scheduled" %}
            <span class="badge badge-info">Scheduled</span>
            {% else if meeting.status.as_str() == "confirmed" %}
            <span class="badge badge-primary">Confirmed</span>
            {% else if meeting.status.as_str() == "in_progress" %}
            <span class="badge badge-warning">In Progress</span>
            {% else if meeting.status.as_str() == "completed" %}
            <span class="badge badge-success">Completed</span>
            {% else if meeting.status.as_str() == "cancelled" %}
            <span class="badge badge-danger">Cancelled</span>
            {% else %}
            <span class="badge badge-muted">{{ meeting.status }}</span>
            {% endif %}
        </span>
    </div>

    <div class="detail-row">
        <span class="detail-label">Date</span>
        <span class="detail-value">{{ meeting.meeting_date }}</span>
    </div>

    {% if !meeting.location.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Location</span>
        <span class="detail-value">{{ meeting.location }}</span>
    </div>
    {% endif %}

    <div class="detail-row">
        <span class="detail-label">Terms of Reference</span>
        <span class="detail-value"><a href="/tor/{{ tor_id }}">{{ meeting.tor_label }}</a></span>
    </div>

    {% if !meeting.notes.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Notes</span>
        <span class="detail-value">{{ meeting.notes }}</span>
    </div>
    {% endif %}

    {% if !meeting.meeting_number.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Meeting Number</span>
        <span class="detail-value">{{ meeting.meeting_number }}</span>
    </div>
    {% endif %}

    {% if !meeting.classification.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Classification</span>
        <span class="detail-value">{{ meeting.classification }}</span>
    </div>
    {% endif %}

    {% if !meeting.vtc_details.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">VTC Details</span>
        <span class="detail-value">{{ meeting.vtc_details }}</span>
    </div>
    {% endif %}

    {% if !meeting.chair_user_id.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Chair</span>
        <span class="detail-value">{{ meeting.chair_user_id }}</span>
    </div>
    {% endif %}

    {% if !meeting.secretary_user_id.is_empty() %}
    <div class="detail-row">
        <span class="detail-label">Secretary</span>
        <span class="detail-value">{{ meeting.secretary_user_id }}</span>
    </div>
    {% endif %}
</div>

<!-- Agenda Points -->
<section class="section">
    <div class="section-header">
        <h2>Agenda Points ({{ agenda_points.len() }})</h2>
    </div>

    {% if agenda_points.is_empty() %}
    <p class="empty-hint">No agenda points assigned to this meeting.</p>
    {% else %}
    <table class="table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Type</th>
                <th>Status</th>
                {% if meeting.status.as_str() == "confirmed" %}
                <th>Actions</th>
                {% else if meeting.status.as_str() == "in_progress" %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for point in agenda_points %}
            <tr>
                <td><a href="/tor/{{ tor_id }}/workflow/agenda/{{ point.id }}">{{ point.label }}</a></td>
                <td>
                    {% if point.item_type.as_str() == "decision" %}
                    <span class="badge badge-warning">Decision</span>
                    {% else %}
                    <span class="badge badge-info">Informative</span>
                    {% endif %}
                </td>
                <td><span class="badge badge-{{ point.status }}">{{ point.status }}</span></td>
                {% if meeting.status.as_str() == "confirmed" %}
                <td>
                    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/agenda/remove" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                        <input type="hidden" name="agenda_point_id" value="{{ point.id }}">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                    </form>
                </td>
                {% else if meeting.status.as_str() == "in_progress" %}
                <td>
                    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/agenda/remove" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
                        <input type="hidden" name="agenda_point_id" value="{{ point.id }}">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                    </form>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Assign unassigned agenda points (only for confirmed/in_progress) -->
    {% if meeting.status.as_str() == "confirmed" %}
    {% if !unassigned_points.is_empty() %}
    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/agenda/assign" class="form-inline" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
        <select name="agenda_point_id" class="input" required>
            <option value="">-- Select agenda point --</option>
            {% for point in unassigned_points %}
            <option value="{{ point.id }}">{{ point.label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-primary">Assign to Meeting</button>
    </form>
    {% endif %}
    {% else if meeting.status.as_str() == "in_progress" %}
    {% if !unassigned_points.is_empty() %}
    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/agenda/assign" class="form-inline" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
        <select name="agenda_point_id" class="input" required>
            <option value="">-- Select agenda point --</option>
            {% for point in unassigned_points %}
            <option value="{{ point.id }}">{{ point.label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-sm btn-primary">Assign to Meeting</button>
    </form>
    {% endif %}
    {% endif %}
</section>

<!-- Protocol Steps -->
<section class="section">
    <div class="section-header">
        <h2>Protocol Steps ({{ protocol_steps.len() }})</h2>
    </div>

    {% if protocol_steps.is_empty() %}
    <p class="empty-hint">No protocol steps defined for this Terms of Reference.</p>
    {% else %}
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>Step</th>
                <th>Type</th>
                <th>Duration</th>
                <th>Required</th>
            </tr>
        </thead>
        <tbody>
            {% for step in protocol_steps %}
            <tr>
                <td>{{ step.sequence_order }}</td>
                <td>
                    <strong>{{ step.label }}</strong>
                    {% if !step.description.is_empty() %}
                    <br><small>{{ step.description }}</small>
                    {% endif %}
                </td>
                <td><span class="badge badge-muted">{{ step.step_type }}</span></td>
                <td>
                    {% if let Some(dur) = step.default_duration_minutes %}
                    {{ dur }} min
                    {% else %}
                    --
                    {% endif %}
                </td>
                <td>{% if step.is_required %}Yes{% else %}No{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</section>

<!-- Minutes -->
<section class="section">
    <div class="section-header">
        <h2>Minutes</h2>
    </div>

    {% if let Some(m) = minutes %}
    <div class="detail-card">
        <div class="detail-row">
            <span class="detail-label">Minutes</span>
            <span class="detail-value"><a href="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/minutes/{{ m.id }}">{{ m.label }}</a></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value"><span class="badge badge-{{ m.status }}">{{ m.status }}</span></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Generated</span>
            <span class="detail-value">{{ m.generated_date }}</span>
        </div>
    </div>
    {% else %}
    {% if meeting.status.as_str() == "completed" %}
    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/minutes/generate">
        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
        <button type="submit" class="btn btn-primary">Generate Minutes</button>
    </form>
    {% else %}
    <p class="empty-hint">Minutes will be available after the meeting is completed.</p>
    {% endif %}
    {% endif %}
</section>

<!-- Roll Call -->
<section class="section">
    <div class="section-header">
        <h2>Roll Call</h2>
    </div>

    <script type="application/json" id="roll-call-data">{{ meeting.roll_call_data|safe }}</script>

    <table class="table" id="roll-call-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
                {% if ctx.permissions.has("tor.edit") %}
                <th></th>
                {% else %}{% if tor_capabilities.has("can_record_decisions") %}
                <th></th>
                {% endif %}{% endif %}
            </tr>
        </thead>
        <tbody id="roll-call-body">
            <!-- Populated by JS -->
        </tbody>
    </table>

    {% if ctx.permissions.has("tor.edit") %}
    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn-sm btn-secondary" id="add-roll-call-row">+ Add Person</button>
    </div>

    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/roll-call" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
        <input type="hidden" name="roll_call_data" id="roll-call-json">
        <button type="submit" class="btn btn-primary btn-sm" id="save-roll-call">Save Roll Call</button>
    </form>
    {% else %}{% if tor_capabilities.has("can_record_decisions") %}
    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn-sm btn-secondary" id="add-roll-call-row">+ Add Person</button>
    </div>

    <form method="post" action="/tor/{{ tor_id }}/meetings/{{ meeting.id }}/roll-call" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ ctx.csrf_token }}">
        <input type="hidden" name="roll_call_data" id="roll-call-json">
        <button type="submit" class="btn btn-primary btn-sm" id="save-roll-call">Save Roll Call</button>
    </form>
    {% endif %}{% endif %}
</section>

<script>
(function() {
    const STATUS_OPTIONS = ['present', 'absent', 'excused'];
    const tbody = document.getElementById('roll-call-body');
    const jsonInput = document.getElementById('roll-call-json');
    const addBtn = document.getElementById('add-roll-call-row');
    const canEdit = !!addBtn;  // presence of add button = has permission

    function makeRow(username, status) {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'input input--sm';
        nameInput.placeholder = 'Name';
        nameInput.value = username || '';
        nameInput.readOnly = !canEdit;
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        const statusTd = document.createElement('td');
        const statusSel = document.createElement('select');
        statusSel.className = 'input input--sm';
        statusSel.disabled = !canEdit;
        STATUS_OPTIONS.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            if (opt === status) o.selected = true;
            statusSel.appendChild(o);
        });
        statusTd.appendChild(statusSel);
        tr.appendChild(statusTd);

        if (canEdit) {
            const actionTd = document.createElement('td');
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', () => tr.remove());
            actionTd.appendChild(removeBtn);
            tr.appendChild(actionTd);
        }

        return tr;
    }

    // Load existing data
    const existing = JSON.parse(document.getElementById('roll-call-data').textContent || '[]');
    existing.forEach(entry => tbody.appendChild(makeRow(entry.username, entry.status)));

    if (canEdit) {
        addBtn.addEventListener('click', () => tbody.appendChild(makeRow('', 'present')));

        // Serialize on form submit
        document.getElementById('save-roll-call').closest('form').addEventListener('submit', () => {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = rows.map(tr => {
                const inputs = tr.querySelectorAll('input, select');
                return { username: inputs[0].value.trim(), status: inputs[1].value };
            }).filter(e => e.username);
            jsonInput.value = JSON.stringify(data);
        });
    }
})();
</script>
{% endblock %}
