<script>
(function() {
    const STATUS_OPTIONS = ['present', 'absent', 'excused'];
    const tbody = document.getElementById('roll-call-body');
    const jsonInput = document.getElementById('roll-call-json');
    const addBtn = document.getElementById('add-roll-call-row');
    const canEdit = !!addBtn;  // presence of add button = has permission

    function makeRow(username, status) {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'input input--sm';
        nameInput.placeholder = 'Name';
        nameInput.value = username || '';
        nameInput.readOnly = !canEdit;
        nameTd.appendChild(nameInput);
        tr.appendChild(nameTd);

        const statusTd = document.createElement('td');
        const statusSel = document.createElement('select');
        statusSel.className = 'input input--sm';
        statusSel.disabled = !canEdit;
        STATUS_OPTIONS.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt;
            if (opt === status) o.selected = true;
            statusSel.appendChild(o);
        });
        statusTd.appendChild(statusSel);
        tr.appendChild(statusTd);

        if (canEdit) {
            const actionTd = document.createElement('td');
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.textContent = 'Ã—';
            removeBtn.addEventListener('click', () => tr.remove());
            actionTd.appendChild(removeBtn);
            tr.appendChild(actionTd);
        }

        return tr;
    }

    // Load existing data
    const existing = JSON.parse(document.getElementById('roll-call-data').textContent || '[]');
    existing.forEach(entry => tbody.appendChild(makeRow(entry.username, entry.status)));

    if (canEdit) {
        addBtn.addEventListener('click', () => tbody.appendChild(makeRow('', 'present')));

        // Serialize on form submit
        document.getElementById('save-roll-call').closest('form').addEventListener('submit', () => {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = rows.map(tr => {
                const inputs = tr.querySelectorAll('input, select');
                return { username: inputs[0].value.trim(), status: inputs[1].value };
            }).filter(e => e.username);
            jsonInput.value = JSON.stringify(data);
        });
    }
})();
</script>
