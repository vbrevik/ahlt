# Database Environment Separation Design

**Date:** 2026-02-15
**Status:** Approved

## Problem

The project uses a single `data/app.db` for development, manual testing, and staging. Automated tests duplicate the schema from `db.rs` and leave orphan WAL/SHM files in `test_data/` that pollute git status. There is no way to run the app with rich demo data without contaminating the development database.

## Decision

Approach A: Environment-driven DB paths via `APP_ENV` variable. Simple, standard, easy to extend to config files (Approach B) later.

## Design

### 1. Environment Configuration

`APP_ENV` env var with three values:

| Value | DB Path | Seed | Audit Path |
|-------|---------|------|------------|
| `dev` (default) | `data/dev/app.db` | Minimal (admin only) | `data/dev/audit/` |
| `staging` | `data/staging/app.db` | Rich (multiple users/roles/data) | `data/staging/audit/` |
| *(tests)* | `tempfile::TempDir` | Per-test setup | None |

Resolution in `main.rs`:
```rust
let env = std::env::var("APP_ENV").unwrap_or_else(|_| "dev".to_string());
let data_dir = format!("data/{}", env);
std::fs::create_dir_all(&data_dir)?;
let db_path = format!("{}/app.db", data_dir);
let pool = db::init_pool(&db_path);
```

Usage: `APP_ENV=staging cargo run`

### 2. Schema Reuse for Tests

Export schema and helpers from `db.rs`:

- `MIGRATIONS` const → `pub`
- `insert_entity`, `insert_prop`, `insert_relation` → `pub`

Tests use real schema:
```rust
use ahlt::db;

fn setup_test_db() -> (TempDir, rusqlite::Connection) {
    let dir = TempDir::new().unwrap();
    let db_path = dir.path().join("test.db");
    let conn = rusqlite::Connection::open(&db_path).unwrap();
    conn.execute_batch("PRAGMA foreign_keys=ON; PRAGMA journal_mode=WAL;").unwrap();
    conn.execute_batch(db::MIGRATIONS).unwrap();
    (dir, conn)
}
```

Zero schema duplication. TempDir auto-deletes on drop.

### 3. Staging Seed Data

Separate `seed_staging()` function that builds on `seed_ontology()`:

- Runs `seed_ontology()` first (relation types, roles, permissions, admin, nav)
- Adds staging-specific data: additional roles (editor, viewer, manager), users (alice, bob, charlie, diana), sample ToR/suggestions/proposals
- Additive and idempotent — checks before inserting, safe to run repeatedly
- Controlled replacement — delete `data/staging/app.db` and restart for fresh state

In `main.rs`:
```rust
match env.as_str() {
    "staging" => db::seed_staging(&pool, &admin_hash),
    _ => db::seed_ontology(&pool, &admin_hash),
}
```

### 4. Test Cleanup

- Add `test_data/` to `.gitignore`
- Delete existing `test_data/` directory (all contents regenerated by tests)
- Add `tempfile` to `[dev-dependencies]`
- Rewrite Phase 2a and 2b tests to use `TempDir` + `ahlt::db::MIGRATIONS`
- Remove manual `cleanup_test_db()` helpers

### 5. Migration Path

One-time steps:
1. Move `data/app.db` → `data/dev/app.db`
2. Update `.gitignore`: add `test_data/`
3. Delete `test_data/` directory

## Files Changed

| File | Change |
|------|--------|
| `src/main.rs` | Read `APP_ENV`, build data dir path, conditional seed |
| `src/db.rs` | Make `MIGRATIONS` pub, make helpers pub, add `seed_staging()` |
| `Cargo.toml` | Add `tempfile` to dev-dependencies |
| `tests/phase2a_integration_test.rs` | Rewrite to use `ahlt::db::MIGRATIONS` + `TempDir` |
| `tests/phase2b_e2e_test.rs` | Rewrite to use real schema + `TempDir` |
| `.gitignore` | Add `test_data/` |
| `src/audit/mod.rs` | Use env-relative audit path |

## What Stays the Same

- All handler code unchanged
- All template code unchanged
- Schema itself unchanged
- `cargo run` with no env var works exactly as before (defaults to `dev`)
